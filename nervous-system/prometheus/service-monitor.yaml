# nervous-system/prometheus/service-monitor.yaml
# This manifest is a set of nerves, telling the central nervous system (Prometheus)
# how to connect to and listen to the vital signs from our organs. It MUST be
# deployed in the same namespace as Prometheus itself ('monitoring').

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: organism-services-monitor
  namespace: monitoring # This is CRITICAL. It must live with Prometheus.
  labels:
    # This label allows the Prometheus instance to discover this monitor.
    # The default for the kube-prometheus-stack chart is 'release: <helm-release-name>'.
    release: prometheus-stack
spec:
  # This selector tells the ServiceMonitor which Services to target.
  # We are targeting any Service that has the 'app' label, which covers both our organs.
  # It will look for these services in ANY namespace.
  namespaceSelector:
    any: true
  selector:
    matchExpressions:
      - key: app
        operator: Exists
  endpoints:
    # This specifies which port on the selected Services to scrape metrics from.
    - port: http-metrics
      interval: 15s # How often to check the organ's vital signs.
      path: /metrics
